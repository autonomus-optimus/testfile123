<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shaka Player Video Stream</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.0/controls.min.css" rel="stylesheet">
    <style>
        .container {
            max-width: 800px;
            margin: 50px auto;
            text-align: center;
            padding: 20px;
            background-color: #f4f4f4;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        #video-container {
            width: 100%;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #video {
            width: 100%;
            height: auto;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #error-message {
            display: none;
            color: red;
            font-size: 16px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Shaka Player Video Stream</h1>
        <div id="video-container">
            <video id="video" autoplay></video>
        </div>
        <p id="error-message"></p>
    </div>

    <!-- Load Shaka Player library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.0/shaka-player.ui.min.js"></script>
    <script>
        // Wait for the document to be fully loaded
        document.addEventListener('DOMContentLoaded', initApp);

        // Check if the browser supports the Shaka Player
        function initApp() {
            // Install built-in polyfills to patch browser incompatibilities
            shaka.polyfill.installAll();

            // Check to see if the browser supports the basic APIs Shaka needs
            if (shaka.Player.isBrowserSupported()) {
                // Browser is supported!
                initPlayer();
            } else {
                // Browser is not supported!
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = 'Browser not supported for Shaka Player!';
                errorMessage.style.display = 'block';
                document.getElementById('video-container').style.display = 'none';
            }
        }

        async function initPlayer() {
            const videoElement = document.getElementById('video');
            const videoContainer = document.getElementById('video-container');
            const errorMessage = document.getElementById('error-message');

            try {
                // Create a Player instance
                const player = new shaka.Player(videoElement);

                // Attach player to the window for debugging
                window.player = player;

                // Listen for error events
                player.addEventListener('error', onErrorEvent);

                // Configure the player
                player.configure({
                    preferredTextLanguage: 'en',
                    preferredAudioLanguage: 'en',
                    streaming: {
                        rebufferingGoal: 2,
                        bufferingGoal: 10,
                        retryParameters: {
                            timeout: 10000, // 10s timeout
                            maxAttempts: 3,
                            backoffFactor: 2
                        }
                    },
                    abr: {
                        enabled: true,
                        defaultBandwidthEstimate: 1000000 // 1Mbps default
                    }
                });

                // Try to fetch the video URL from the Flask backend
                const response = await fetch('/get-video-url');

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                if (!data.videoUrl) {
                    throw new Error('No video URL provided from server');
                }

                // Initialize UI configuration
                const uiConfig = {
                    addBigPlayButton: true,
                    addSeekBar: true,
                    controlPanelElements: [
                        'play_pause',
                        'time_and_duration',
                        'spacer',
                        'mute',
                        'volume',
                        'fullscreen',
                        'overflow_menu'
                    ],
                    overflowMenuButtons: [
                        'captions',
                        'quality',
                        'language',
                        'playback_rate',
                        'picture_in_picture'
                    ],
                    seekBarColors: {
                        base: 'rgba(255, 255, 255, 0.3)',
                        buffered: 'rgba(255, 255, 255, 0.54)',
                        played: 'rgb(255, 255, 255)'
                    }
                };

                // Create UI factory and configure
                const ui = new shaka.ui.Overlay(player, videoContainer, videoElement);
                ui.configure(uiConfig);

                // Get UI controls for later manipulation if needed
                const controls = ui.getControls();

                // Load the stream
                await player.load(data.videoUrl);
                console.log('Video loaded successfully');

                // Add event listener for track changes to see if tracks are being detected
                player.addEventListener('trackschanged', () => {
                    const tracks = player.getVariantTracks();
                    console.log('Available tracks:', tracks);

                    const textTracks = player.getTextTracks();
                    console.log('Available text tracks:', textTracks);
                });

            } catch (error) {
                // Log and display the error
                console.error('Error:', error);
                onError(error);
            }
        }

        function onErrorEvent(event) {
            // Extract the error from the event
            onError(event.detail);
        }

        function onError(error) {
            const videoContainer = document.getElementById('video-container');
            const errorMessage = document.getElementById('error-message');

            let errorMsg = "An unknown error occurred.";

            if (error instanceof shaka.util.Error) {
                errorMsg = `Shaka Player Error: ${error.code}, ${error.message}`;
            } else if (error instanceof Error) {
                errorMsg = `Error: ${error.message}`;
            } else if (typeof error === 'string') {
                errorMsg = `Error: ${error}`;
            } else if (error && error.message) {
                errorMsg = `Error: ${error.message}`;
            }

            console.error(errorMsg);
            errorMessage.textContent = errorMsg;
            errorMessage.style.display = 'block';
        }
    </script>
</body>

</html>